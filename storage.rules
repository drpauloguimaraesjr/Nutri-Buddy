rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Regra para uploads de prescritores
    match /prescribers/{prescriberId}/{allPaths=**} {
      // Permitir leitura e escrita apenas para o pr√≥prio prescritor autenticado
      allow read, write: if request.auth != null && 
                          (request.auth.uid == prescriberId || 
                           get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    // Regra para uploads de pacientes
    match /patients/{patientId}/{allPaths=**} {
      // Permitir leitura para o paciente e seu prescritor
      allow read: if request.auth != null && 
                    (request.auth.uid == patientId ||
                     get(/databases/(default)/documents/users/$(patientId)).data.prescriberId == request.auth.uid ||
                     get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin');
      
      // Permitir escrita para o paciente e seu prescritor
      allow write: if request.auth != null && 
                     (request.auth.uid == patientId ||
                      get(/databases/(default)/documents/users/$(patientId)).data.prescriberId == request.auth.uid ||
                      get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    // Bloquear todo o resto
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

