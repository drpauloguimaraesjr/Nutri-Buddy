rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // ===== CHAT MEDIA =====
    // Imagens e áudios enviados no chat entre paciente e prescritor
    match /chat-media/{patientId}/{prescriberId}/{conversationId}/{fileName} {
      // Qualquer um pode ler (URLs assinadas funcionam)
      allow read: if true;
      
      // Apenas usuários autenticados podem fazer upload
      allow write: if request.auth != null;
    }
    
    // ===== DIET PLANS =====
    // PDFs dos planos nutricionais
    match /diet-plans/{patientId}/{fileName} {
      // Leitura: usuário autenticado
      allow read: if request.auth != null;
      
      // Escrita: apenas prescritores
      allow write: if request.auth != null && 
                     request.auth.token.role == 'prescriber';
    }
    
    // Imagens dos planos nutricionais (usadas no PDF)
    match /diet-plans-images/{patientId}/{fileName} {
      // Leitura: usuário autenticado
      allow read: if request.auth != null;
      
      // Escrita: apenas prescritores
      allow write: if request.auth != null && 
                     request.auth.token.role == 'prescriber';
    }
    
    // ===== UPLOADS DE PRESCRITORES =====
    match /prescribers/{prescriberId}/{allPaths=**} {
      // Permitir leitura e escrita apenas para o próprio prescritor autenticado
      allow read, write: if request.auth != null && 
                          (request.auth.uid == prescriberId || 
                           get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    // ===== UPLOADS DE PACIENTES =====
    match /patients/{patientId}/{allPaths=**} {
      // Permitir leitura para o paciente e seu prescritor
      allow read: if request.auth != null && 
                    (request.auth.uid == patientId ||
                     get(/databases/(default)/documents/users/$(patientId)).data.prescriberId == request.auth.uid ||
                     get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin');
      
      // Permitir escrita para o paciente e seu prescritor
      allow write: if request.auth != null && 
                     (request.auth.uid == patientId ||
                      get(/databases/(default)/documents/users/$(patientId)).data.prescriberId == request.auth.uid ||
                      get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
    
    // ===== BLOQUEAR TODO O RESTO =====
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

