{
  "name": "Evolution: Atualizar Score ao Registrar RefeiÃ§Ã£o",
  "nodes": [
    {
      "parameters": {
        "authentication": "serviceAccount",
        "projectId": "nutribuddy-2fc9c",
        "operation": "listen",
        "collection": "meals",
        "filters": {}
      },
      "name": "Firestore Trigger: Nova RefeiÃ§Ã£o",
      "type": "n8n-nodes-base.firestore",
      "typeVersion": 1,
      "position": [250, 300],
      "credentials": {
        "googleServiceAccount": {
          "id": "1",
          "name": "Firebase Service Account"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "projectId": "nutribuddy-2fc9c",
        "operation": "query",
        "collection": "meals",
        "returnAll": false,
        "limit": 100,
        "filters": {
          "conditions": [
            {
              "field": "userId",
              "operator": "==",
              "value": "={{$json.userId}}"
            }
          ]
        },
        "options": {
          "orderBy": [
            {
              "field": "createdAt",
              "direction": "desc"
            }
          ]
        }
      },
      "name": "Buscar Ãšltimas 100 RefeiÃ§Ãµes",
      "type": "n8n-nodes-base.firestore",
      "typeVersion": 1,
      "position": [450, 300],
      "credentials": {
        "googleServiceAccount": {
          "id": "1",
          "name": "Firebase Service Account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Calcular score baseado nas refeiÃ§Ãµes\nconst meals = $input.all();\nconst patientId = $('Firestore Trigger: Nova RefeiÃ§Ã£o').item.json.userId;\n\n// Se nÃ£o houver refeiÃ§Ãµes, retornar score inicial\nif (!meals || meals.length === 0) {\n  return {\n    patientId,\n    totalScore: 50,\n    adherencePercentage: 50,\n    mealsLogged: 0,\n    correctMeals: 0,\n    consecutiveDays: 0,\n    badges: [],\n    lastMealDate: null,\n    updatedAt: new Date()\n  };\n}\n\n// Extrair dados das refeiÃ§Ãµes\nconst mealData = meals.map(m => ({\n  timestamp: m.json.createdAt?._seconds ? new Date(m.json.createdAt._seconds * 1000) : new Date(m.json.createdAt || Date.now()),\n  isCorrect: m.json.followsPlan !== false, // Assume correto se nÃ£o especificado\n  hasImage: !!m.json.imageUrl,\n  quality: m.json.quality || 80\n}));\n\n// Contador de refeiÃ§Ãµes\nconst mealsLogged = mealData.length;\nconst correctMeals = mealData.filter(m => m.isCorrect).length;\nconst mealsWithImages = mealData.filter(m => m.hasImage).length;\n\n// CÃ¡lculo de aderÃªncia (% de refeiÃ§Ãµes corretas)\nconst adherencePercentage = mealsLogged > 0 \n  ? Math.round((correctMeals / mealsLogged) * 100)\n  : 0;\n\n// CÃ¡lculo de dias consecutivos\nconst mealsByDay = new Map();\nmealData.forEach(meal => {\n  const dayKey = meal.timestamp.toISOString().split('T')[0];\n  if (!mealsByDay.has(dayKey)) {\n    mealsByDay.set(dayKey, []);\n  }\n  mealsByDay.get(dayKey).push(meal);\n});\n\nconst sortedDays = Array.from(mealsByDay.keys()).sort().reverse();\nlet consecutiveDays = 0;\nconst today = new Date().toISOString().split('T')[0];\nlet currentDate = new Date(today);\n\nfor (let i = 0; i < 30; i++) {\n  const dateKey = currentDate.toISOString().split('T')[0];\n  const dayMeals = mealsByDay.get(dateKey) || [];\n  const hasCorrectMeal = dayMeals.some(m => m.isCorrect);\n  \n  if (hasCorrectMeal) {\n    consecutiveDays++;\n  } else {\n    break;\n  }\n  \n  currentDate.setDate(currentDate.getDate() - 1);\n}\n\n// Ãšltima refeiÃ§Ã£o\nconst sortedMeals = [...mealData].sort((a, b) => b.timestamp - a.timestamp);\nconst lastMealDate = sortedMeals.length > 0 ? sortedMeals[0].timestamp : null;\n\n// Componentes do score (total 100 pontos)\nconst idealWeeklyMeals = 21; // 3 refeiÃ§Ãµes por dia x 7 dias\nconst mealFrequencyScore = Math.min((mealsLogged / (idealWeeklyMeals * 2)) * 30, 30);\nconst adherenceScore = (adherencePercentage / 100) * 40;\nconst consistencyScore = Math.min((consecutiveDays / 7) * 20, 20);\n\nconst avgQuality = mealData.reduce((sum, m) => {\n  const baseQuality = m.quality || (m.isCorrect ? 80 : 40);\n  const imageBonus = m.hasImage ? 10 : 0;\n  return sum + Math.min(baseQuality + imageBonus, 100);\n}, 0) / mealData.length;\n\nconst qualityScore = (avgQuality / 100) * 10;\n\nconst totalScore = Math.min(\n  100,\n  Math.round(mealFrequencyScore + adherenceScore + consistencyScore + qualityScore)\n);\n\n// Calcular badges\nconst badges = [];\n\nif (adherencePercentage === 100 && consecutiveDays >= 7) {\n  badges.push('champion');\n}\nif (consecutiveDays >= 7) {\n  badges.push('streak_7');\n}\nif (consecutiveDays >= 30) {\n  badges.push('streak_30');\n}\nif (mealsLogged >= 50) {\n  badges.push('star_50');\n}\nif (adherencePercentage >= 90 && mealsLogged >= 20) {\n  badges.push('focused_90');\n}\nif (totalScore >= 85) {\n  badges.push('high_performer');\n}\n\nreturn {\n  patientId,\n  totalScore,\n  adherencePercentage,\n  mealsLogged,\n  correctMeals,\n  consecutiveDays,\n  badges,\n  lastMealDate,\n  updatedAt: new Date()\n};"
      },
      "name": "Calcular Score",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "projectId": "nutribuddy-2fc9c",
        "operation": "query",
        "collection": "whatsappConversations",
        "returnAll": false,
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "field": "patientId",
              "operator": "==",
              "value": "={{$json.patientId}}"
            }
          ]
        }
      },
      "name": "Buscar Conversa WhatsApp",
      "type": "n8n-nodes-base.firestore",
      "typeVersion": 1,
      "position": [850, 300],
      "credentials": {
        "googleServiceAccount": {
          "id": "1",
          "name": "Firebase Service Account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.length > 0}}",
              "value2": true
            }
          ]
        }
      },
      "name": "Conversa Existe?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "projectId": "nutribuddy-2fc9c",
        "operation": "update",
        "collection": "whatsappConversations",
        "documentId": "={{$json[0].id}}",
        "fields": {
          "score": "={{$node['Calcular Score'].json}}",
          "updatedAt": "={{new Date()}}"
        }
      },
      "name": "Atualizar Score na Conversa",
      "type": "n8n-nodes-base.firestore",
      "typeVersion": 1,
      "position": [1250, 200],
      "credentials": {
        "googleServiceAccount": {
          "id": "1",
          "name": "Firebase Service Account"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "previousBadges",
              "value": "={{JSON.stringify($json[0].score?.badges || [])}}"
            },
            {
              "name": "newBadges",
              "value": "={{JSON.stringify($node['Calcular Score'].json.badges || [])}}"
            },
            {
              "name": "patientName",
              "value": "={{$json[0].patientName}}"
            },
            {
              "name": "conversationId",
              "value": "={{$json[0].id}}"
            },
            {
              "name": "newScore",
              "value": "={{$node['Calcular Score'].json.totalScore}}"
            }
          ]
        }
      },
      "name": "Preparar Dados para NotificaÃ§Ã£o",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [1450, 200]
    },
    {
      "parameters": {
        "jsCode": "// Verificar se conquistou novos badges\nconst previousBadges = JSON.parse($json.previousBadges);\nconst newBadges = JSON.parse($json.newBadges);\n\nconst conqueredBadges = newBadges.filter(badge => !previousBadges.includes(badge));\n\nreturn {\n  ...$ input.first().json,\n  conqueredBadges,\n  hasNewBadges: conqueredBadges.length > 0\n};"
      },
      "name": "Verificar Novos Badges",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 200]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.hasNewBadges}}",
              "value2": true
            }
          ]
        }
      },
      "name": "Conquistou Novo Badge?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1850, 200]
    },
    {
      "parameters": {
        "jsCode": "// Mapear badges para mensagens\nconst badgeMessages = {\n  champion: 'ðŸ† CAMPEÃƒO! 100% de aderÃªncia por 1 semana!',\n  streak_7: 'ðŸ”¥ 7 DIAS CONSECUTIVOS! VocÃª estÃ¡ no fogo!',\n  streak_30: 'ðŸ’ª 30 DIAS CONSECUTIVOS! VocÃª Ã© DEDICADO!',\n  star_50: 'â­ ESTRELA! 50+ refeiÃ§Ãµes registradas!',\n  focused_90: 'ðŸŽ¯ FOCADO! 90%+ de aderÃªncia!',\n  high_performer: 'ðŸš€ ALTO DESEMPENHO! Score acima de 85!',\n  top_3: 'ðŸ‘‘ TOP 3 DO MÃŠS! VocÃª Ã© REI/RAINHA!'\n};\n\nconst badges = $json.conqueredBadges || [];\nconst messages = badges.map(badge => badgeMessages[badge] || `ðŸŽ‰ Novo badge conquistado: ${badge}`);\n\nconst congratsMessage = `ðŸŽ‰ *PARABÃ‰NS ${$json.patientName.toUpperCase()}!*\\n\\nVocÃª acabou de conquistar:\\n\\n${messages.join('\\n')}\\n\\nContinue assim! Seu score atual Ã© *${$json.newScore}*! ðŸ’ª`;\n\nreturn {\n  conversationId: $json.conversationId,\n  patientId: $node['Calcular Score'].json.patientId,\n  message: congratsMessage\n};"
      },
      "name": "Criar Mensagem de ParabÃ©ns",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2050, 100]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "projectId": "nutribuddy-2fc9c",
        "operation": "create",
        "collection": "whatsappMessages",
        "fields": {
          "conversationId": "={{$json.conversationId}}",
          "patientId": "={{$json.patientId}}",
          "senderId": "system",
          "senderName": "Sistema NutriBuddy",
          "senderType": "system",
          "content": "={{$json.message}}",
          "timestamp": "={{new Date()}}",
          "isFromPatient": false,
          "analyzed": true,
          "sent": false
        }
      },
      "name": "Salvar Mensagem de ParabÃ©ns",
      "type": "n8n-nodes-base.firestore",
      "typeVersion": 1,
      "position": [2250, 100],
      "credentials": {
        "googleServiceAccount": {
          "id": "1",
          "name": "Firebase Service Account"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "status",
              "value": "completed"
            }
          ]
        }
      },
      "name": "Workflow Finalizado",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [2450, 200]
    }
  ],
  "connections": {
    "Firestore Trigger: Nova RefeiÃ§Ã£o": {
      "main": [[{ "node": "Buscar Ãšltimas 100 RefeiÃ§Ãµes", "type": "main", "index": 0 }]]
    },
    "Buscar Ãšltimas 100 RefeiÃ§Ãµes": {
      "main": [[{ "node": "Calcular Score", "type": "main", "index": 0 }]]
    },
    "Calcular Score": {
      "main": [[{ "node": "Buscar Conversa WhatsApp", "type": "main", "index": 0 }]]
    },
    "Buscar Conversa WhatsApp": {
      "main": [[{ "node": "Conversa Existe?", "type": "main", "index": 0 }]]
    },
    "Conversa Existe?": {
      "main": [[{ "node": "Atualizar Score na Conversa", "type": "main", "index": 0 }]]
    },
    "Atualizar Score na Conversa": {
      "main": [[{ "node": "Preparar Dados para NotificaÃ§Ã£o", "type": "main", "index": 0 }]]
    },
    "Preparar Dados para NotificaÃ§Ã£o": {
      "main": [[{ "node": "Verificar Novos Badges", "type": "main", "index": 0 }]]
    },
    "Verificar Novos Badges": {
      "main": [[{ "node": "Conquistou Novo Badge?", "type": "main", "index": 0 }]]
    },
    "Conquistou Novo Badge?": {
      "main": [
        [{ "node": "Criar Mensagem de ParabÃ©ns", "type": "main", "index": 0 }],
        [{ "node": "Workflow Finalizado", "type": "main", "index": 0 }]
      ]
    },
    "Criar Mensagem de ParabÃ©ns": {
      "main": [[{ "node": "Salvar Mensagem de ParabÃ©ns", "type": "main", "index": 0 }]]
    },
    "Salvar Mensagem de ParabÃ©ns": {
      "main": [[{ "node": "Workflow Finalizado", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  }
}

